.. _microporter:

********
Описание
********

**microporter** - программное обеспечение сервера *Microimpuls Video Transporter*,
предназначенное для доставки видеопотоков через Интернет, используя специализированный
протокол передачи данных, который базируется на TCP или UDP транспорте.
Применяются алгоритмы буферизации и выравнивания Transport Stream потоков для обеспечения
стабильной доставки в условиях нестабильной линии связи.

********************
Системные требования
********************

microporter предназначен для работы в ОС Linux Debian 64-битной версии и подобных
дистрибутивах, по-умолчанию поставляется версия для архитектуры amd64.

*Внимание! ПО microporter не предназначено для работы на виртуальной машине.*

Требования к аппаратному обеспечению, исходя из принимаемого/передающегося объема трафика:

+--------------------+------------------------------------------------------------------------------------------------------+
| Процессор          | 1 ядро 2.4Ghz+ на каждые 200Mbps трафика                                                             |
+--------------------+------------------------------------------------------------------------------------------------------+
| Оперативная память | 1GB на каждые 200Mbps трафика                                                                        |
+--------------------+------------------------------------------------------------------------------------------------------+
| Сетевая карта      | карта с Enterprise чипом Intel, имеющая несколько очередей для входящих пакетов (multiple Rx queues) |
+--------------------+------------------------------------------------------------------------------------------------------+

*************************
Установка и использование
*************************

Для работы microporter необходимо наличие библиотек *libmedia*, *libjsonrpc*, *libjson*.

*libmedia* - библиотека для работы с UDP/TCP сокетами, разрабатывается вместе с microporter.

microporter, а также все необходимые библиотеки совместимых версий, поставляются в виде
установочных deb-пакетов и устанавливаются утилитой dpkg. См. раздел :ref:`Где взять <download-software>`.

Для запуска используется init.d скрипт: ``/etc/init.d/microporter``, доступные аргументы:
::
    # /etc/init.d/microporter
    Usage: /etc/init.d/microporter {start|stop|restart|force-reload|reload}

Файлы логов по-умолчанию сохраняются в ``/var/log/microporter/microporter.log``,
включена ротация логов через logrotate.d

.. _download-software:

Где взять
=========

TODO: ссылка на сообщество

Конфигурация
============

Файл конфигурации находится в ``/etc/microporter/microporter.conf``,
задаётся в формате JSON. Пример:
::
    {
        "log-syslog": false,
        "log-facility": 0,
        "log-path": "/var/log/microporter/microporter.log",
        "log-verbose-level": 3,
        "log-foreground": false,
        "json-rpc-enabled": true,
        "json-rpc-listen-host": "0.0.0.0",
        "json-rpc-listen-port": 8089,
        "streaming-enabled": true,
        "priority": 0,
        "adaptive-delays-enabled": true,
        "rebuffering-enabled": true,
        "ts-processing-enabled": false,
        "write-aux-enabled": false,
        "backup-src": "",
        "input-buffer-duration": 3000, // msec
        "input-buffer-max-duration": 3000, // msec
        "input-buffer-max-size": 48 // mb
        "output-buffer-max-size": 48 // mb
        "license-owner": "Demo",
        "license-streams-limit": 20,
        "license-code": "1452c-527c0-8cbfe-74f10-15f5a",
        "streams": [
            {
                "name": "Dummy channel",
                "enabled": true,
                "src": "239.152.2.1 1234 multicast udp",
                "dst": "198.51.100.15 2001 unicast tcp",
                "backup-src": "",
                "payload-size": 1316, // b
                "ttl": 32,
                "input-buffer-duration": 3000, // msec
                "input-buffer-max-duration": 3000, // msec
                "input-buffer-max-size": 48 // mb
                "output-buffer-max-size": 48 // mb
            }
        ],
        "ranges": [
            {
                "name": "Dummy range",
                "enabled": true,
                "src-from": "239.152.2.1 1234 multicast udp",
                "src-to": "239.152.2.10 1234 multicast udp",
                "dst-from": "198.51.100.15 2001 unicast tcp",
                "dst-to": "198.51.100.15 2010 unicast tcp",
            }
        ]
    }

Описание параметров
-------------------

+---------------------------+------+---------------------------------------------------------------------+
| Параметр                  | Тип  | Описание                                                            |
+---------------------------+------+---------------------------------------------------------------------+
| log-syslog                | bool | Использовать ли службу syslogd для записи логов в /var/log/syslog.  |
|                           |      | Не рекомендуется включать при интенсивном логировании.              |
+---------------------------+------+---------------------------------------------------------------------+
| log-facility              | int  | Тег в syslog                                                        |
+---------------------------+------+---------------------------------------------------------------------+
| log-path                  | str  | Путь до лог-файла для логирования напрямую без syslogd.             |
+---------------------------+------+---------------------------------------------------------------------+
| log-verbose-level         | int  | Уровень логирования от 0 до 9, 9 - максимальный DEBUG уровень.      |
+---------------------------+------+---------------------------------------------------------------------+
| log-foreground            | bool | Вывод лога в stdout                                                 |
+---------------------------+------+---------------------------------------------------------------------+
| json-rpc-listen-host      | str  | Адрес интерфейса для ожидания входящих подключений к JSON RPC API,  |
|                           |      | 0.0.0.0 - слушать на всех интерфейсах.                              |
+---------------------------+------+---------------------------------------------------------------------+
| json-rpc-listen-port      | int  | Номер порта TCP для JSON RPC API, по-умолчанию 8089.                |
+---------------------------+------+---------------------------------------------------------------------+
| streaming-enabled         | bool | Глобальный флаг, если true - доставка включена, false - выключена.  |
+---------------------------+------+---------------------------------------------------------------------+
| priority                  | int  | Приоритет процесса в ОС, 0 - автоматический приоритет по выбору ОС. |
|                           |      | Не рекомендуется использовать высокий приоритет при большом         |
|                           |      | количестве анализируемых потоков.                                   |
+---------------------------+------+---------------------------------------------------------------------+
| adaptive-delays-enabled   | bool | Включает режим адаптивного буфера. Данный режим используется для    |
|                           |      | расширенного контроля за входящим битрейтом видеопотока в условиях  |
|                           |      | нестабильной линии. Может вносить PCR задержки в поток.             |
+---------------------------+------+---------------------------------------------------------------------+
| rebuffering-enabled       | bool | При включении данного режима система будет производить              |
|                           |      | перебуферизацию потока каждый раз в случае опустошения буфера.      |
+---------------------------+------+---------------------------------------------------------------------+
| ts-processing-enabled     | bool | Включает режим анализа и выравнивания TS-фреймов. При активировании |
|                           |      | данного режима система будет анализировать входящий Transport       |
|                           |      | Stream поток, обнаруживать ошибки и, по-возможности, выстраивать    |
|                           |      | правильный порядок и выровненный битрейт пакетов.                   |
+---------------------------+------+---------------------------------------------------------------------+
| write-aux-enabled         | bool | Включает режим записи aux-файлов при выводе потока в файл.          |
|                           |      | aux-файлы необходимы для сохранения информации о таймингах пакетов, |
|                           |      | для последующего стриминга потока из файла без необходимости        |
|                           |      | анализа TS-фреймов.                                                 |
+---------------------------+------+---------------------------------------------------------------------+
| input-buffer-duration     | int  |                                                                     |
+---------------------------+------+---------------------------------------------------------------------+
| input-buffer-max-duration | int  |                                                                     |
+---------------------------+------+---------------------------------------------------------------------+
| input-buffer-max-size     | int  |                                                                     |
+---------------------------+------+---------------------------------------------------------------------+
| output-buffer-max-size    | int  |                                                                     |
+---------------------------+------+---------------------------------------------------------------------+
| backup-src                | uri  | Адрес backup-потока. В случае возникновения ситуации, когда для     |
|                           |      |                                                                     |
|                           |      | любого из доставляемых/принимаемых видеопотоков нет входящего       |
|                           |      | сигнала, система может переключить трансляцию по данному потоку на  |
|                           |      | резервный поток.                                                    |
+---------------------------+------+---------------------------------------------------------------------+
| license-owner             | str  | Имя лицензии                                                        |
+---------------------------+------+---------------------------------------------------------------------+
| license-streams-limit     | int  | Количество потоков, разрешенное лицензией                           |
+---------------------------+------+---------------------------------------------------------------------+
| license-code              | str  | Лицензионный ключ                                                   |
+---------------------------+------+---------------------------------------------------------------------+
| streams                   | list | Список потоков для приема/передачи                                  |
+---------------------------+------+---------------------------------------------------------------------+

Описание параметров потоков в списке streams
--------------------------------------------

+---------------------------+------+---------------------------------------------------------------------+
| Параметр                  | Тип  | Описание                                                            |
+---------------------------+------+---------------------------------------------------------------------+
| name                      | str  | Имя потока. Может быть определено автоматически из TS-потока при    |
|                           |      | включенном режиме ``ts-processing-enabled``                         |
+---------------------------+------+---------------------------------------------------------------------+
| enabled                   | bool | Флаг активности приема/передачи потока
+---------------------------+------+---------------------------------------------------------------------+
| src                       | uri  | Адрес, на котором ожидается прием потока
+---------------------------+------+---------------------------------------------------------------------+
| dst                       | uri  | Адрес, на который будет отправлен поток
+---------------------------+------+---------------------------------------------------------------------+
| backup-src                | uri  | Адрес резервного потока, на который будет переключен поток src      |
|                           |      | в случае отсутствия. Переопределяет глобальный ``backup-src``       |
+---------------------------+------+---------------------------------------------------------------------+
| payload-size              | int  | Размер полезных данных в байтах в одном сетевом пакете.
|                           |      | По-умолчанию, значение 1316, соответствует максимальному размеру
|                           |      | пакета, который помещается в стандартный MTU 1500. Значение 1316
|                           |      | (7 TS-фреймов по 188 байт) подходит для большинства случаев.
+---------------------------+------+---------------------------------------------------------------------+
| ttl                       | int  | Время жизни пакета
+---------------------------+------+---------------------------------------------------------------------+
| input-buffer-duration     | int  | Длительность буфера входящих данных в миллисекундах.
|                           |      | Переопределяет глобальное значение ``input-buffer-duration``        |
+---------------------------+------+---------------------------------------------------------------------+
| input-buffer-max-duration | int  | Максимальная длительность буфера входящих данных в миллисекундах.
|                           |      | В пределах этого значения буфер будет автоматически подстраиваться,
|                           |      | в зависимости от частоты перебуферизаций.
|                           |      | Переопределяет глобальное значение ``input-buffer-max-duration``    |

input-buffer-max-size – максимальный размер буфера входящих данных в мегабайтах [int]. При достижении максимума буфер очищается.

output-buffer-max-size – максимальный размер буфера исходящих данных в мегабайтах [int]. При достижении максимума очередь исходящих пакетов очищается.

Параметры буферизации могут быть определены также в глобальной секции.

В секции ranges описываются диапазоны адресов и портов, для удобной передачи большой группы потоков.