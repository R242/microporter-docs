.. _microporter:

********
Описание
********

**microporter** - программное обеспечение сервера *Microimpuls Video Transporter*,
предназначенное для доставки видеопотоков через Интернет, используя специализированный
протокол передачи данных, который базируется на TCP или UDP транспорте.
Используются алгоритмы буферизации и выравнивания Transport Stream потоков для обеспечения
стабильной доставки в условиях нестабильной линии связи.

********************
Системные требования
********************

microporter предназначен для работы в ОС Linux Debian 64-битной версии и подобных
дистрибутивах, по-умолчанию поставляется версия для архитектуры amd64.

*Внимание! ПО microporter не предназначено для работы на виртуальной машине.*

Требования к аппаратному обеспечению, исходя из принимаемого/передающегося объема трафика:

+--------------------+------------------------------------------------------------------------------------------------------+
| Процессор          | 1 ядро 2.4Ghz+ на каждые 200Mbps трафика                                                             |
+--------------------+------------------------------------------------------------------------------------------------------+
| Оперативная память | 1GB на каждые 200Mbps трафика                                                                        |
+--------------------+------------------------------------------------------------------------------------------------------+
| Сетевая карта      | карта с Enterprise чипом Intel, имеющая несколько очередей для входящих пакетов (multiple Rx queues) |
+--------------------+------------------------------------------------------------------------------------------------------+

*************************
Установка и использование
*************************

Для работы microporter необходимо наличие библиотек *libmedia*, *libjsonrpc*, *libjson*.

*libmedia* - библиотека для работы с UDP/TCP сокетами, разрабатывается вместе с microporter.

microporter, а также все необходимые библиотеки совместимых версий, поставляются в виде
установочных deb-пакетов и устанавливаются утилитой dpkg. См. раздел :ref:`Где взять <download-software>`.

Для запуска используется init.d скрипт: ``/etc/init.d/microporter``, доступные аргументы:
::
    # /etc/init.d/microporter
    Usage: /etc/init.d/microporter {start|stop|restart|force-reload|reload}

Файлы логов по-умолчанию сохраняются в ``/var/log/microporter/microporter.log``,
включена ротация логов через logrotate.d

.. _download-software:

Где взять
=========

TODO: ссылка на сообщество

Конфигурация
============

Файл конфигурации находится в ``/etc/microporter/microporter.conf``,
задаётся в формате JSON. Пример:
::
    {
        "log-syslog": false,
        "log-facility": 0,
        "log-path": "/var/log/microporter/microporter.log",
        "log-verbose-level": 3,
        "log-foreground": false,
        "json-rpc-enabled": true,
        "json-rpc-listen-host": "0.0.0.0",
        "json-rpc-listen-port": 8089,
        "streaming-enabled": true,
        "priority": 0,
        "adaptive-delays-enabled": true,
        "rebuffering-enabled": true,
        "ts-processing-enabled": false,
        "write-aux-enabled": false,
        "backup-src": "",
        "input-buffer-duration": 3000, // msec
        "input-buffer-max-duration": 3000, // msec
        "input-buffer-max-size": 48 // mb
        "output-buffer-max-size": 48 // mb
        "license-owner": "Demo",
        "license-streams-limit": 20,
        "license-code": "1452c-527c0-8cbfe-74f10-15f5a",
        "streams": [
            {
                "name": "Dummy channel",
                "enabled": true,
                "src": "239.152.2.1 1234 multicast udp",
                "dst": "198.51.100.15 2001 unicast tcp",
                "backup-src": "",
                "payload-size": 1316, // b
                "ttl": 32,
                "input-buffer-duration": 3000, // msec
                "input-buffer-max-duration": 3000, // msec
                "input-buffer-max-size": 48 // mb
                "output-buffer-max-size": 48 // mb
            }
        ],
        "ranges": [
            {
                "name": "Dummy range",
                "enabled": true,
                "src-from": "239.152.2.1 1234 multicast udp",
                "src-to": "239.152.2.10 1234 multicast udp",
                "dst-from": "198.51.100.15 2001 unicast tcp",
                "dst-to": "198.51.100.15 2010 unicast tcp",
            }
        ]
    }

Описание параметров
-------------------

+---------------------------+--------------+---------------------------------------------------------------------+
| Параметр                  | Тип значения | Описание                                                            |
+---------------------------+--------------+---------------------------------------------------------------------+
| log-syslog                | ``bool``     | Использовать ли службу syslogd для записи логов в /var/log/syslog,  |
|                           |              | Не рекомендуется включать при интенсивном логировании.              |
+---------------------------+--------------+---------------------------------------------------------------------+

log-facility – тег в syslog, тип ``int``

log-path – путь до лог-файла [string]

log-verbose-level – уровень логирования от 0 до 9, 9 - максимальный DEBUG уровень [int]

log-foreground – вывод лога в stdout [bool]

json-rpc-listen-host – адрес интерфейса для ожидания входящих подключений к JSON RPC API [string]

json-rpc-listen-port – номер порта TCP для JSON RPC API [int]

streaming-enabled – флаг, если true - доставка включена, false - выключена [bool]

priority – приоритет процесса в ОС, 0 - автоматический приоритет по выбору ОС [int]. Не рекомендуется использовать высокий приоритет при большом количестве анализируемых потоков.

adaptive-delays-enabled – включает режим адаптивного буфера [bool]. Данный режим используется для расширенного контроля за входящим битрейтом видеопотока в условиях нестабильной линии.

rebuffering-enabled – при включении данного режима система будет производить перебуферизацию потока каждый раз в случае опустошения буфера [bool]

ts-processing-enabled – включает режим анализа и выравнивания TS-фреймов [bool]. При активировании данного режима система будет анализировать входящий Transport Stream поток, обнаруживать ошибки и, по-возможности, выстраивать правильный порядок и выровненный битрейт пакетов.

write-aux-enabled – включает режим записи aux-файлов при выводе потока в файл [bool]. aux-файлы необходимы для сохранения информации о таймингах пакетов, для последующего стриминга потока из файла без необходимости анализа TS-фреймов.

backup-src – адрес backup-потока [uri]. В случае возникновения ситуации, когда для любого из доставляемых/принимаемых видеопотоков нет входящего сигнала, система может переключить трансляцию по данному потоку на резервный поток.

license-owner – имя лицензии [str]

license-streams-limit – количество потоков, разрешенные лицензией [int]

license-code – лицензионный код [str]

streams – список потоков приема/передачи [list]